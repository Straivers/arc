/**
A single file which is to be parsed completely
*/
module arc.syntax.tests.long_parser;

immutable text = `
def float3 : [x: float, y: float, z: float]

def float3x3 :
[
    float, float, float
    float, float, float
    float, float, float
]

def identity_3x3 : float3x3 = [
    1, 0, 0
    0, 1, 0
    0, 0, 1
]

def float3_multiply := (v: float3, s: float) -> float3 {
    result : float3 = [
        v.x * s
        v.y * s
        v.z * s
    ]

    return result
}

def float3x3_multiply : (float3x3, float) -> float3x3 = (m33, v) -> {
    result : float3x3
    
    i := 0
    'loop loop {if (i < m33.length) {
        result[i] = m33[i] * v
    } else { break 'loop }}

    return result
}

def float3x3_multiply := (m33: float3x3, v: float3) -> float3 {
    return [
        m33[0] * v[0] + m33[1] * v[1] + m33[2] * v[2]
        m33[3] * v[0] + m33[4] * v[1] + m33[5] * v[2]
        m33[6] * v[0] + m33[7] * v[1] + m33[8] * v[2]
    ]
}

def float3x3_cross : (float3x3, float3x3) -> float3
`;

import arc.syntax.ast: AstNode;

AstNode.Type[] types = () {
    with (AstNode.Type) {
        return [
            Module,
                Define, // float3
                    Name,
                    TypeList,
                        TypeListMember,
                            Name,
                            Name,
                        TypeListMember,
                            Name,
                            Name,
                        TypeListMember,
                            Name,
                            Name,
                    None,
                Define, // float3x3
                    Name,
                    TypeList,
                        TypeListMember,
                            None,
                            Name,
                        TypeListMember,
                            None,
                            Name,
                        TypeListMember,
                            None,
                            Name,
                        TypeListMember,
                            None,
                            Name,
                        TypeListMember,
                            None,
                            Name,
                        TypeListMember,
                            None,
                            Name,
                        TypeListMember,
                            None,
                            Name,
                        TypeListMember,
                            None,
                            Name,
                        TypeListMember,
                            None,
                            Name,
                    None,
                Define, // identity_3x3
                    Name,
                    Name,
                    List,
                        ListMember,
                            None,
                            None,
                            Integer,
                        ListMember,
                            None,
                            None,
                            Integer,
                        ListMember,
                            None,
                            None,
                            Integer,
                        ListMember,
                            None,
                            None,
                            Integer,
                        ListMember,
                            None,
                            None,
                            Integer,
                        ListMember,
                            None,
                            None,
                            Integer,
                        ListMember,
                            None,
                            None,
                            Integer,
                        ListMember,
                            None,
                            None,
                            Integer,
                        ListMember,
                            None,
                            None,
                            Integer,
                Define, // float3x3_multiply
                    Name,
                    None,
                    Function,
                        List,
                            ListMember,
                                Name,
                                Name,
                                None,
                            ListMember,
                                Name,
                                Name,
                                None,
                        Name,
                        Block,
                            VarExpression,
                                Name,
                                Name,
                                List,
                                    ListMember,
                                        None,
                                        None,
                                        Multiply,
                                            Call,
                                                Name,
                                                Name,
                                            Name,
                                    ListMember,
                                        None,
                                        None,
                                        Multiply,
                                            Call,
                                                Name,
                                                Name,
                                            Name,
                                    ListMember,
                                        None,
                                        None,
                                        Multiply,
                                            Call,
                                                Name,
                                                Name,
                                            Name,
                            Return,
                                None,
                                Name,
                Define, // float3x3_multiply
                    Name,
                    FunctionType,
                        TypeList,
                            TypeListMember,
                                None,
                                Name,
                            TypeListMember,
                                None,
                                Name,
                        Name,
                    Function,
                        List,
                            ListMember,
                                None,
                                None,
                                Name,
                            ListMember,
                                None,
                                None,
                                Name,
                        None,
                        Block,
                            VarExpression,
                                Name,
                                Name,
                                None,
                            VarExpression,
                                Name,
                                None,
                                Integer,
                            Labeled,
                                Label,
                                Loop,
                                    Block,
                                        If,
                                            List,
                                                ListMember,
                                                    None,
                                                    None,
                                                    Less,
                                                        Name,
                                                        Call,
                                                            Name,
                                                            Name,
                                            Block,
                                                Assign,
                                                    Call,
                                                        Name,
                                                        List,
                                                            ListMember,
                                                                None,
                                                                None,
                                                                Name,
                                                    Multiply,
                                                        Call,
                                                            Name,
                                                            List,
                                                                ListMember,
                                                                    None,
                                                                    None,
                                                                    Name,
                                                        Name,
                                        Block,
                                            Break,
                                                Label,
                                                None,
                    Return,
                        None,
                        Name,
                Define, // float3x3_multiply
                    Name,
                    None,
                    Function,
                        List,
                            ListMember,
                                Name,
                                Name,
                                None,
                            ListMember,
                                Name,
                                Name,
                                None,
                        Name,
                        Block,
                            Return,
                                None,
                                List,
                                    ListMember,
                                        None,
                                        None,
                                        Add,
                                            Add,
                                                Multiply,
                                                    Call,
                                                        Name,
                                                        List,
                                                            ListMember,
                                                                None,
                                                                None,
                                                                Integer,
                                                    Call,
                                                        Name,
                                                        List,
                                                            ListMember,
                                                                None,
                                                                None,
                                                                Integer,
                                                Multiply,
                                                    Call,
                                                        Name,
                                                        List,
                                                            ListMember,
                                                                None,
                                                                None,
                                                                Integer,
                                                    Call,
                                                        Name,
                                                        List,
                                                            ListMember,
                                                                None,
                                                                None,
                                                                Integer,
                                            Multiply,
                                                    Call,
                                                        Name,
                                                        List,
                                                            ListMember,
                                                                None,
                                                                None,
                                                                Integer,
                                                    Call,
                                                        Name,
                                                        List,
                                                            ListMember,
                                                                None,
                                                                None,
                                                                Integer,
                                    ListMember,
                                        None,
                                        None,
                                        Add,
                                            Add,
                                                Multiply,
                                                    Call,
                                                        Name,
                                                        List,
                                                            ListMember,
                                                                None,
                                                                None,
                                                                Integer,
                                                    Call,
                                                        Name,
                                                        List,
                                                            ListMember,
                                                                None,
                                                                None,
                                                                Integer,
                                                Multiply,
                                                    Call,
                                                        Name,
                                                        List,
                                                            ListMember,
                                                                None,
                                                                None,
                                                                Integer,
                                                    Call,
                                                        Name,
                                                        List,
                                                            ListMember,
                                                                None,
                                                                None,
                                                                Integer,
                                            Multiply,
                                                    Call,
                                                        Name,
                                                        List,
                                                            ListMember,
                                                                None,
                                                                None,
                                                                Integer,
                                                    Call,
                                                        Name,
                                                        List,
                                                            ListMember,
                                                                None,
                                                                None,
                                                                Integer,
                                    ListMember,
                                        None,
                                        None,
                                        Add,
                                            Add,
                                                Multiply,
                                                    Call,
                                                        Name,
                                                        List,
                                                            ListMember,
                                                                None,
                                                                None,
                                                                Integer,
                                                    Call,
                                                        Name,
                                                        List,
                                                            ListMember,
                                                                None,
                                                                None,
                                                                Integer,
                                                Multiply,
                                                    Call,
                                                        Name,
                                                        List,
                                                            ListMember,
                                                                None,
                                                                None,
                                                                Integer,
                                                    Call,
                                                        Name,
                                                        List,
                                                            ListMember,
                                                                None,
                                                                None,
                                                                Integer,
                                            Multiply,
                                                    Call,
                                                        Name,
                                                        List,
                                                            ListMember,
                                                                None,
                                                                None,
                                                                Integer,
                                                    Call,
                                                        Name,
                                                        List,
                                                            ListMember,
                                                                None,
                                                                None,
                                                                Integer,
                Define, // float3x3_cross
                    Name,
                    FunctionType,
                        TypeList,
                            TypeListMember,
                                None,
                                Name,
                            TypeListMember,
                                None,
                                Name,
                        Name,
                    None
        ];
    }
} ();

@("long parser") unittest {
    import arc.syntax.tests.parser: test_parse;
    import arc.syntax.parser: parse_module;

    assert(test_parse!parse_module(cast(const(char)[]) text, types) == []);
}

@("long parser flatten") unittest {
    import arc.syntax.tests.parser: parse;
    import arc.syntax.parser: parse_module;
    import arc.syntax.flat_ast: flatten;
    
    auto result = parse!parse_module(cast(const(char)[]) text);
    auto flat_tree = flatten(result.count, result.tree);

    import std.range: zip;
    foreach (pair; zip(flat_tree, types))
        assert(pair[0].type == pair[1]);
}
